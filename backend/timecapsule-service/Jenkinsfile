pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Build and Deploy Timecapsule Service') {
            steps {
                withCredentials([file(credentialsId: 'timecapsule-application.yml', variable: 'application_yml')]) {
                    script {
                        dir('backend/timecapsule-service') {
                            copyApplicationYaml(application_yml)
                            buildAndRunContainer('timecapsule-service')
                        }
                    }
                }
            }
        }
    }
}

// 공통 함수: application.yml 복사
def copyApplicationYaml(application_yml) {
    sh 'mkdir -p src/main/resources'
    sh "cp ${application_yml} src/main/resources/application.yml"
}

// 공통 함수: 컨테이너 중지 및 삭제
def stopAndRemoveContainer(containerName) {
    // 기존 컨테이너 중지 및 삭제
    sh """
    docker-compose -f /home/.ssh/docker-compose.yml stop timecapsule-service || true
    docker-compose -f /home/.ssh/docker-compose.yml rm -f timecapsule-service || true
    """
}

// 공통 함수: 컨테이너 빌드 및 실행
def buildAndRunContainer(serviceName) {
    stopAndRemoveContainer(serviceName)

    // 해당 컨테이너만 재시작
    sh """
    docker-compose -f /home/.ssh/docker-compose.yml build --no-cache timecapsule-service
    docker-compose -f /home/.ssh/docker-compose.yml up -d --no-deps --build timecapsule-service
    """
}
