// Pipeline variable declaration with initial value set to the actual blue instance name
def activeInstance = ''

pipeline {
    agent any

    stages {
        stage('Initialize Active Instance') {
            steps {
                script {
                    // Check if 'timecapsule-service' is currently active; if so, set it as the activeInstance
                    activeInstance = sh(script: "docker ps --filter 'name=timecapsule-service' --format '{{.Names}}'", returnStdout: true).trim()

                    // If no active instance found, set activeInstance to 'timecapsule-service' by default
                    if (!activeInstance) {
                        activeInstance = 'timecapsule-service'
                    }
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build and Deploy TimeCapsule Service') {
            steps {
                withCredentials([file(credentialsId: 'timecapsule-application.yml', variable: 'application_yml')]) {
                    script {
                        // Determine newInstance based on current active instance
                        def newInstance = (activeInstance == 'timecapsule-service') ? 'timecapsule-service-green' : 'timecapsule-service'

                        // Only proceed to build and deploy if newInstance is different from activeInstance
                        if (activeInstance != newInstance) {
                            dir('backend/timecapsule-service') {
                                // Build and run the new instance
                                copyApplicationYaml(application_yml)
                                buildAndRunContainer(newInstance)
                            }

                            // Stop and remove the old instance
                            stopAndRemoveContainer(activeInstance)

                            // Update activeInstance to newInstance
                            activeInstance = newInstance
                        } else {
                            echo "Using existing active instance: ${activeInstance}"
                        }
                    }
                }
            }
        }
    }
}

// Function to copy application.yml
def copyApplicationYaml(application_yml) {
    sh 'mkdir -p src/main/resources'
    sh "cp ${application_yml} src/main/resources/application.yml"
}

// Function to stop and remove container
def stopAndRemoveContainer(containerName) {
    def containerId = sh(script: "docker ps -a --filter 'name=${containerName}' --format '{{.ID}}'", returnStdout: true).trim()

    if (containerId) {
        // Stop the container
        echo "Stopping container ${containerName} with ID: ${containerId}"
        int stopStatus = sh(script: "docker stop ${containerId}", returnStatus: true)

        if (stopStatus == 0) {
            echo "Container ${containerName} stopped successfully."
            // Remove the container
            int rmStatus = sh(script: "docker rm ${containerId}", returnStatus: true)
            if (rmStatus == 0) {
                echo "Container ${containerName} removed successfully."
            } else {
                echo "Failed to remove container ${containerName}."
            }
        } else {
            echo "Failed to stop container ${containerName}."
        }
    } else {
        echo "No container found with the name: ${containerName}"
    }
}

// Function to build and run container
def buildAndRunContainer(serviceName) {
    stopAndRemoveContainer(serviceName)
    sh 'chmod +x ./gradlew'
    sh './gradlew clean build -x test'
    sh "docker build -t ${serviceName} ."
    sh "docker run --name ${serviceName} -d ${serviceName}"
}
