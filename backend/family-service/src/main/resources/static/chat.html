<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h2>WebSocket Chat</h2>
<div>
    <input type="text" id="userId" placeholder="User ID">
    <input type="text" id="roomId" placeholder="Room ID">
    <input type="text" id="message" placeholder="Message">
    <div>
        <label>
            <input type="radio" name="messageType" value="message" checked onclick="toggleVoteOptions()"> 일반 메시지
        </label>
        <label>
            <input type="radio" name="messageType" value="vote" onclick="toggleVoteOptions()"> 투표 메시지
        </label>
    </div>
    <input type="text" id="voteTitle" placeholder="투표 제목" style="display: none;">
    <button onclick="connect()">Connect</button>
    <button onclick="sendMessage()">Send</button>
</div>
<div id="chat-log"></div>

<script>
    let stompClient = null;
    let isConnected = false;

    function toggleVoteOptions() {
        const voteTitleInput = document.getElementById("voteTitle");
        const messageType = document.querySelector('input[name="messageType"]:checked').value;
        voteTitleInput.style.display = messageType === "vote" ? "block" : "none";
    }

    function connect() {
        if (isConnected) {
            alert("이미 연결되어 있습니다.");
            return;
        }
        const userId = document.getElementById("userId").value;
        const roomId = document.getElementById("roomId").value;

        if (!userId || !roomId) {
            alert("User ID와 Room ID를 입력해주세요.");
            return;
        }

        fetchChatHistory(roomId, userId);

        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);

        stompClient.connect(
            { "X-User-ID": userId },
            () => {
                stompClient.subscribe(`/room/${roomId}`, (message) => {
                    const parsedMessage = JSON.parse(message.body);
                    console.log("New message received:", parsedMessage);
                    displayMessageByType(parsedMessage);
                });
                isConnected = true;
                console.log("WebSocket connected and subscribed to /room/" + roomId);
            }
        );
    }

    async function fetchChatHistory(roomId, userId) {
        try {
            const response = await fetch(`/rooms/enter/${roomId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                }
            });
            const result = await response.json();
            const chatLog = document.getElementById("chat-log");
            chatLog.innerHTML = "";

            if (result.data && Array.isArray(result.data)) {
                result.data.forEach(message => {
                    displayMessageByType(message);
                });
            } else {
                console.warn("No chat data available.");
            }
        } catch (error) {
            console.error("채팅 기록을 불러오는 중 오류 발생:", error);
        }
    }

    function sendMessage() {
        const roomId = document.getElementById("roomId").value;
        const userId = document.getElementById("userId").value;
        const messageContent = document.getElementById("message").value;
        const isVote = document.querySelector('input[name="messageType"]:checked').value === 'vote';
        const voteTitle = isVote ? document.getElementById("voteTitle").value : null;

        if (isVote && !voteTitle) {
            alert("투표 제목을 입력하세요.");
            return;
        }

        if (stompClient && stompClient.connected) {
            stompClient.send(`/send/chat.send`, {}, JSON.stringify({
                roomId: roomId,
                senderId: userId,
                content: messageContent,
                createdAt: new Date().toISOString(),
                isVote: isVote,
                voteTitle: voteTitle
            }));
            document.getElementById("message").value = "";
            if (isVote) document.getElementById("voteTitle").value = "";
        } else {
            alert("WebSocket 서버에 연결되어 있지 않습니다.");
        }
    }

    function sendVoteResponse(roomId, voteId, response) {
        const userId = document.getElementById("userId").value;

        if (!userId || !roomId || !voteId) {
            alert("User ID, Room ID, 또는 Vote ID가 없습니다.");
            return;
        }

        if (stompClient && stompClient.connected) {
            stompClient.send(`/send/chat.vote`, {}, JSON.stringify({
                roomId: roomId,
                senderId: userId,
                voteId: voteId,
                isVoteResponse: true,
                responseOfVote: response
            }));
            console.log(`[sendVoteResponse] 응답 전송: ${response}`);
        } else {
            alert("WebSocket 서버에 연결되어 있지 않습니다.");
        }
    }

    function displayMessageByType(message) {
        const chatLog = document.getElementById("chat-log");
        console.log("Displaying message by type:", message);

        let content = `<div style="border: 1px solid #ccc; padding: 10px; margin: 5px;">
            <p><strong>채팅 ID:</strong> ${message.chatId || "N/A"}</p>
            <p><strong>방 ID:</strong> ${message.roomId}</p>
            <p><strong>발신자 ID:</strong> ${message.senderId}</p>
            <p><strong>발신자 닉네임:</strong> ${message.sender ? message.sender.userNickname : "Unknown"}</p>
            <p><strong>내용:</strong> ${message.content}</p>
            <p><strong>보낸 시간:</strong> ${new Date(message.createdAt).toLocaleString()}</p>`;

        if (message.isVote) {
            // 투표 메시지
            content += `
                <p><strong>투표 제목:</strong> ${message.vote.voteTitle}</p>
                <button onclick="sendVoteResponse('${message.roomId}', '${message.vote.voteId}', '찬성')">찬성</button>
                <button onclick="sendVoteResponse('${message.roomId}', '${message.vote.voteId}', '반대')">반대</button>`;
        } else if (message.isVoteResponse) {
            // 투표 응답 메시지
            content += `<p><strong>투표 응답:</strong> ${message.responseOfVote}</p>`;
        } else if (message.isVoteResult && message.resultOfVote) {
            // 투표 결과 메시지
            content += `<p><strong>투표 결과:</strong></p><ul>`;
            for (const [option, count] of Object.entries(message.resultOfVote)) {
                content += `<li>${option}: ${count}명</li>`;
            }
            content += `</ul>`;
        } else {
            // 일반 메시지
            content += `<p>일반 메시지</p>`;
        }

        content += `</div>`;
        chatLog.innerHTML += content;
    }
</script>
</body>
</html>
