<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h2>WebSocket Chat</h2>
<div>
    <input type="text" id="userId" placeholder="User ID">
    <input type="text" id="roomId" placeholder="Room ID">
    <input type="text" id="message" placeholder="Message">
    <button onclick="connect()">Connect</button>
    <button onclick="sendMessage()">Send</button>
</div>
<div id="chat-log"></div>

<script>
    let stompClient = null;
    let isConnected = false;

    async function fetchChatHistory(roomId, userId) {
        try {
            const response = await fetch(`/rooms/enter/${roomId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                }
            });
            const result = await response.json();
            const chatLog = document.getElementById("chat-log");
            chatLog.innerHTML = "";
            result.data.forEach(message => {
                showMessage(message);
            });
        } catch (error) {
            console.error("채팅 기록을 불러오는 중 오류 발생:", error);
        }
    }

    function connect() {
        if (isConnected) {
            alert("이미 연결되어 있습니다.");
            return;
        }
        const userId = document.getElementById("userId").value;
        console.log("userId: ", userId);
        const roomId = document.getElementById("roomId").value;
        console.log("roomId: ", roomId);

        if (!userId || !roomId) {
            alert("User ID와 Room ID를 입력해주세요.");
            return;
        }

        fetchChatHistory(roomId, userId);

        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);

        // 헤더가 잘 들어가는지 확인하기 위한 로그 출력
        console.log("WebSocket 연결 시 X-User-ID 헤더:", userId);

        stompClient.connect(
            { "X-User-ID": userId },  // 헤더에 X-User-ID 추가
            () => {
                stompClient.subscribe(`/room/${roomId}`, (message) => {
                    showMessage(JSON.parse(message.body));
                });
                isConnected = true;
            }
        );
    }


    function sendMessage() {
        const roomId = document.getElementById("roomId").value;
        const userId = document.getElementById("userId").value;
        const messageContent = document.getElementById("message").value;

        if (stompClient && stompClient.connected) {
            stompClient.send(`/send/${roomId}`, {}, JSON.stringify({
                roomId: roomId,
                senderId: userId,
                senderNickname: `User${userId}`,
                senderProfileImage: "profile.jpg",
                content: messageContent,
                messageChecked: false,
                sendTime: new Date().toISOString()
            }));
            document.getElementById("message").value = "";
        } else {
            alert("WebSocket 서버에 연결되어 있지 않습니다.");
        }
    }

    function showMessage(message) {
        const chatLog = document.getElementById("chat-log");
        chatLog.innerHTML += `
            <div style="border: 1px solid #ccc; padding: 10px; margin: 5px;">
                <p><strong>${message.senderNickname}:</strong> ${message.content}</p>
                <p><img src="${message.senderZodiacSignImageUrl}" alt="Zodiac Sign" style="width: 20px; height: 20px;"> |
                색상: <span style="color:${message.senderColor}">${message.senderColor}</span> |
                전송 시간: ${new Date(message.createdAt).toLocaleString()}</p>
            </div>`;
    }
</script>
</body>
</html>
