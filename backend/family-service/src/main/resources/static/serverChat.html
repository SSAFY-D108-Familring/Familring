<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h2>WebSocket Chat</h2>
<div>
    <input type="text" id="userId" placeholder="User ID">
    <input type="text" id="roomId" placeholder="Room ID">
    <input type="text" id="message" placeholder="Message">
    <div>
        <label>
            <input type="radio" name="messageType" value="MESSAGE" checked onclick="toggleVoteOptions()"> 일반 메시지
        </label>
        <label>
            <input type="radio" name="messageType" value="VOTE" onclick="toggleVoteOptions()"> 투표 메시지
        </label>
    </div>
    <input type="text" id="voteTitle" placeholder="투표 제목" style="display: none;">
    <button onclick="connect()">Connect</button>
    <button onclick="sendMessage()">Send</button>
</div>
<div id="chat-log"></div>
<button onclick="loadMoreMessages()">Load More Messages</button>

<script>
    let stompClient = null;
    let isConnected = false;
    let currentPage = 0;
    const pageSize = 100;

    function toggleVoteOptions() {
        const voteTitleInput = document.getElementById("voteTitle");
        const messageType = document.querySelector('input[name="messageType"]:checked').value;
        voteTitleInput.style.display = messageType === "VOTE" ? "block" : "none";
    }

    function connect() {
        if (isConnected) {
            alert("이미 연결되어 있습니다.");
            return;
        }
        const userId = document.getElementById("userId").value;
        const roomId = document.getElementById("roomId").value;

        if (!userId || !roomId) {
            alert("User ID와 Room ID를 입력해주세요.");
            return;
        }

        fetchChatHistory(roomId, userId, currentPage, pageSize);

        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);

        stompClient.connect(
            { "X-User-ID": userId },
            () => {
                stompClient.subscribe(`/room/${roomId}`, (message) => {
                    const parsedMessage = JSON.parse(message.body);
                    console.log("New message received:", parsedMessage);
                    displayMessageByType(parsedMessage);
                });

                stompClient.subscribe(`/room/${roomId}/readStatus`, () => {
                    fetchChatHistory(roomId, userId);
                });

                stompClient.subscribe(`/room/${roomId}/exit`, (message) => {
                    console.log("Exit message received:", message.body);
                    displayExitMessage(message.body);
                });

                isConnected = true;
                console.log("WebSocket connected and subscribed to /room/" + roomId);
            }
        );
    }

    function displayExitMessage(message) {
        const chatLog = document.getElementById("chat-log");
        console.log("Exit message received:", message);

        const content = `<div style="color: red; padding: 10px; margin: 5px; border: 1px solid #f00;">
        <p><strong>알림:</strong> ${message}</p>
    </div>`;
        chatLog.innerHTML += content;
    }

    async function fetchChatHistory(roomId, userId) {
        try {
            const response = await fetch(`/family/rooms/enter/${roomId}`, {  // '/family' 추가
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                }
            });
            const result = await response.json();
            const chatLog = document.getElementById("chat-log");

            if (!chatLog) {
                console.warn("채팅 기록을 표시할 요소가 없습니다.");
                return;
            }

            chatLog.innerHTML = "";

            if (result.data && Array.isArray(result.data)) {
                result.data.forEach(message => {
                    displayMessageByType(message);
                });
            } else {
                console.warn("No chat data available.");
            }
        } catch (error) {
            console.error("채팅 기록을 불러오는 중 오류 발생:", error);
        }
    }

    function loadMoreMessages() {
        currentPage++;
        const roomId = document.getElementById("roomId").value;
        const userId = document.getElementById("userId").value;
        fetchChatHistory(roomId, userId, currentPage, pageSize);
    }

    function sendMessage
